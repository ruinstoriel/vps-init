#!/usr/sbin/nft -f

flush ruleset

table inet filter {
	# "Mangle Prerouting" equivalent
	# Priority -150 is "mangle". Hook prerouting runs before input.
	chain prerouting {
		type filter hook prerouting priority -150; policy accept;

		# --- Anti-Scanning & Sanity Checks (Early Drop) ---
		
		# Drop invalid connections
		ct state invalid drop

		# Drop new packets that are not SYN (e.g. FIN scans, XMAS scans)
		tcp flags & (fin|syn|rst|ack) != syn ct state new drop

		# Drop packets with invalid TCP flags
		# NULL scan
		tcp flags & (fin|syn|rst|psh|ack|urg) == 0 drop
		# XMAS scan
		tcp flags & (fin|syn|rst|psh|ack|urg) == (fin|psh|urg) drop
		# FIN scan
		tcp flags & (fin|syn|rst|psh|ack|urg) == (fin) drop
		# SYN+RST (invalid)
		tcp flags & (syn|rst) == (syn|rst) drop
	}

	chain input {
		type filter hook input priority 0; policy drop;

		# Allow loopback traffic
		iifname "lo" accept

		# Allow established and related traffic
		ct state established, related accept

		# --- ICMPv4 (Essential) ---
		# Allow critical ICMP types (PMTUD, Traceroute handling)
		ip protocol icmp icmp type { destination-unreachable, router-advertisement, router-solicitation, time-exceeded, parameter-problem } accept
		
		# Allow Ping (Echo Request) with rate limiting
		ip protocol icmp icmp type echo-request limit rate 20/second accept

		# --- ICMPv6 (Essential) ---
		# Allow critical ICMPv6 types (Neighbor Discovery, Router Advertisement, PMTUD)
		# These are essential for IPv6 connectivity and should NOT be rate limited aggressively or dropped.
		ip6 nexthdr icmpv6 icmpv6 type { destination-unreachable, packet-too-big, time-exceeded, parameter-problem, mld-listener-query, mld-listener-report, mld-listener-reduction, nd-router-solicit, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert, ind-neighbor-solicit, ind-neighbor-advert, mld2-listener-report } accept

		# Allow Ping (Echo Request) with rate limiting
		ip6 nexthdr icmpv6 icmpv6 type echo-request limit rate 20/second accept

		# --- Services ---
		# Allow SSH (Port 22)
		tcp dport 22 accept

		# Allow HTTP and HTTPS and quic
		tcp dport { 80, 443 } accept
        udp dport 443  accept
	}
	chain forward {
		type filter hook forward priority 0; policy drop;
	}
	chain output {
		type filter hook output priority 0; policy accept;
	}
}

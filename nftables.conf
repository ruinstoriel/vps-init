#!/usr/sbin/nft -f

flush ruleset

table inet filter {
	set ipv4_block {
        type ipv4_addr
        flags interval
        auto-merge
    }
	set ipv6_block {
        type ipv6_addr
        flags interval
        auto-merge
    }
	# "Mangle Prerouting" equivalent
	# Priority -150 is "mangle". Hook prerouting runs before input.
	chain prerouting {
		type filter hook prerouting priority -150; policy accept;
		ct state established,related accept
		# --- Anti-Scanning & Sanity Checks (Early Drop) ---
		
		# Drop invalid connections
		ct state invalid drop

		# Drop new packets that are not SYN (e.g. FIN scans, XMAS scans)
		tcp flags & (fin|syn|rst|ack) != syn ct state new drop

		# Drop packets with invalid TCP flags
		# NULL scan (no flags set)
		tcp flags & (fin|syn|rst|psh|ack|urg) == 0 drop
		# XMAS scan (FIN+PSH+URG)
		tcp flags & (fin|syn|rst|psh|ack|urg) == (fin|psh|urg) drop
		# FIN scan (only FIN, normal FIN is FIN+ACK)
		tcp flags & (fin|syn|rst|psh|ack|urg) == (fin) drop
		# FIN+SYN (invalid combination)
		tcp flags & (fin|syn) == (fin|syn) drop
		# SYN+RST (invalid combination)
		tcp flags & (syn|rst) == (syn|rst) drop
		# FIN+RST (invalid combination)
		tcp flags & (fin|rst) == (fin|rst) drop
		# ALL flags set (highly suspicious)
		tcp flags & (fin|syn|rst|psh|ack|urg) == (fin|syn|rst|psh|ack|urg) drop
		# SYN+FIN+PSH+URG (variant XMAS)
		tcp flags & (syn|fin|psh|urg) == (syn|fin|psh|urg) drop
		# SYN Flood
		
		ip saddr @ipv4_block drop
		ip6 saddr @ipv6_block drop
		# --- SYN Flood Protection ---
		# Drop SYN packets exceeding 100/sec per IP (burst 50)
		tcp flags & (fin|syn|rst|ack) == syn jump syn_flood

	}
	chain syn_flood {
		tcp option maxseg size < 500 drop
		meter syn_flood { ip saddr timeout 10s limit rate 50/second burst 20 packets } accept
		# limit rate 100/second burst 50 packets return comment "!fw4: Accept SYN packets below rate-limit"
	}
	chain input {
		type filter hook input priority 0; policy drop;

		# Allow loopback traffic
		iifname "lo" accept

		# Allow established and related traffic
		ct state established, related accept

		# --- ICMPv4 (Essential) ---
		# Allow critical ICMP types (PMTUD, Traceroute handling)
		ip protocol icmp icmp type { destination-unreachable, router-advertisement, router-solicitation, time-exceeded, parameter-problem } accept
		
		# Allow Ping (Echo Request) with rate limiting
		ip protocol icmp icmp type echo-request limit rate 20/second accept

		# --- ICMPv6 (Essential) ---
		# Allow critical ICMPv6 types (Neighbor Discovery, Router Advertisement, PMTUD)
		# These are essential for IPv6 connectivity and should NOT be rate limited aggressively or dropped.
		ip6 nexthdr icmpv6 icmpv6 type { destination-unreachable, packet-too-big, time-exceeded, parameter-problem, mld-listener-query, mld-listener-report, mld-listener-reduction, nd-router-solicit, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert, ind-neighbor-solicit, ind-neighbor-advert, mld2-listener-report } accept

		# Allow Ping (Echo Request) with rate limiting
		ip6 nexthdr icmpv6 icmpv6 type echo-request limit rate 20/second accept

		# --- Services ---
		# Allow SSH (Port {{SSH_PORT}})
		tcp dport {{SSH_PORT}} accept

		# Allow HTTP and HTTPS and quic
		tcp dport { 80, 443 } accept
		udp dport 443 accept
		jump input_user_chain
	}
	chain input_user_chain {
		
	}
	chain forward {
		type filter hook forward priority 0; policy drop;
		# Allow established and related traffic
		ct state established, related accept
		jump forward_user_chain
	}
	chain forward_user_chain {
		
	}
	chain output {
		type filter hook output priority 0; policy accept;
	}
}

include "/etc/nftables.d/*.nft"
